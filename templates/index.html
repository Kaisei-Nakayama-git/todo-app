<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Todo App - „É≠„Ç∞„Ç§„É≥ & ÁôªÈå≤</title>
</head>
<body>
  <h1>üìù Todo App</h1>

  <!-- Ë™çË®º„Éï„Ç©„Éº„É† -->
  <div id="auth-section">
    <h2>„É≠„Ç∞„Ç§„É≥</h2>
    <form id="login-form">
      <input type="text" id="login-username" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" required>
      <input type="password" id="login-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" required>
      <button type="submit">„É≠„Ç∞„Ç§„É≥</button>
    </form>

    <h2>„É¶„Éº„Ç∂„ÉºÁôªÈå≤</h2>
    <form id="register-form">
      <input type="text" id="register-username" placeholder="„É¶„Éº„Ç∂„ÉºÂêç" required>
      <input type="password" id="register-password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" required>
      <button type="submit">ÁôªÈå≤</button>
    </form>
  </div>

  <!-- Todo„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <div id="todo-section" style="display: none;">
    <form id="todo-form">
      <input type="text" id="todo-input" placeholder="„ÇÑ„Çã„Åì„Å®" required>
      <button type="submit">ËøΩÂä†</button>
    </form>
    <ul id="todo-list"></ul>
    <button onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
  </div>

  <script>
    const API_URL = "/";
    const tokenKey = "token";

    // „É≠„Ç∞„Ç§„É≥
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;
      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username, password })
      });
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem(tokenKey, data.access_token);
        showTodoSection();
      } else {
        alert("„É≠„Ç∞„Ç§„É≥Â§±ÊïóÔºÅ");
      }
    });

    // ÁôªÈå≤
    document.getElementById("register-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("register-username").value;
      const password = document.getElementById("register-password").value;
      const res = await fetch("/register", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ username, password })
      });
      if (res.ok) {
        alert("ÁôªÈå≤ÂÆå‰∫ÜÔºÅ„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      } else {
        alert("ÁôªÈå≤Â§±ÊïóÔºàÊó¢„Å´‰Ωø„Çè„Çå„Å¶„ÅÑ„Çã„É¶„Éº„Ç∂„ÉºÂêç„Åã„ÇÇÔºâ");
      }
    });

    // TodoÂèñÂæó
    async function fetchTodos() {
      const res = await fetch("/todos", {
        headers: { Authorization: `Bearer ${localStorage.getItem(tokenKey)}` }
      });
      const todos = await res.json();
      const list = document.getElementById("todo-list");
      list.innerHTML = "";

      todos.forEach((todo, index) => {
        const li = document.createElement("li");
        li.textContent = todo.title + (todo.done ? " ‚úÖ" : "");

        if (!todo.done) {
          const doneBtn = document.createElement("button");
          doneBtn.textContent = "ÂÆå‰∫Ü";
          doneBtn.onclick = async () => {
            await fetch(`/todos/${index}`, {
              method: "PUT",
              headers: { Authorization: `Bearer ${localStorage.getItem(tokenKey)}` }
            });
            fetchTodos();
          };
          li.appendChild(doneBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.textContent = "ÂâäÈô§";
        delBtn.onclick = async () => {
          await fetch(`/todos/${index}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${localStorage.getItem(tokenKey)}` }
          });
          fetchTodos();
        };
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    // „Çø„Çπ„ÇØËøΩÂä†
    document.getElementById("todo-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("todo-input").value;
      await fetch("/todos", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${localStorage.getItem(tokenKey)}`
        },
        body: JSON.stringify({ title })
      });
      document.getElementById("todo-input").value = "";
      fetchTodos();
    });

    // Ë°®Á§∫Âàá„ÇäÊõø„Åà
    function showTodoSection() {
      document.getElementById("auth-section").style.display = "none";
      document.getElementById("todo-section").style.display = "block";
      fetchTodos();
    }

    // „É≠„Ç∞„Ç¢„Ç¶„Éà
    function logout() {
      localStorage.removeItem(tokenKey);
      location.reload();
    }

    // Ëá™Âãï„É≠„Ç∞„Ç§„É≥
    if (localStorage.getItem(tokenKey)) {
      showTodoSection();
    }
  </script>
</body>
</html>
